---
title: "11_Prin_Axis"
author: "Mohammed Alrezq"
date: "2023-08-03"
output:
  html_document: default
  word_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# 1. Preliminary 
### 1.1 Load libraires: this need to be 
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(psych)# use perform EFA
library(purrr)
library(ggplot2)
library(gridExtra)# to arrnge plot per row and col
library(corrr)
```


```{r,}
plotTheme <- function() {
  theme(
    plot.title = element_text(size = 14, family = "sans", face = "plain", hjust = 0),
    plot.subtitle=element_text(size = 11, family = "sans", hjust = 0),
    plot.caption=element_text(size = 10, family = "sans", face = "italic", hjust = 0), 
    axis.title.x = element_text(size = 10, family = "sans", face = "plain", hjust = 1, vjust = -0.5),
    axis.title.y = element_text(size = 10, family = "sans", face = "plain", hjust = 1, vjust = 1),
    axis.text = element_text(size = 9, family = "sans", face = "plain"),
    panel.background = element_blank(),
    panel.grid.minor = element_line(colour = "gray"),
    panel.grid.major = element_line(colour = "gray"),
    axis.ticks = element_blank(),
    legend.title = element_text(size = 10, family = "sans"),
    legend.text = element_text(size = 9, family = "sans"),
    axis.line = element_blank()
  )
}
```

## 1.2 load data
```{r}
model_11 <- read.csv("mean_data.csv")

# Remove Response.ID and col X from the data 
model_11 <- model_11 |> 
  select(c(-Response.ID, -X))

# Convert all integer columns to numeric
model_11 <- model_11 |> 
  mutate_if(is.integer, as.numeric)
```

## 1.3 Split data to dependent and independet variables 
```{r}
# Dependent variables/items 
model_11_DVs <- model_11 |> 
  select(1:13)
#str(model_11_DVs)
# Independent variables/items 
model_11_IVs <- model_11 |> 
  select(14:42)
#str(model_11_IVs)
```

# 2 Statistical descriptive
## 2.1 Statistical summary for all variables/itmes 
```{r}
library(vtable)# to print summary table 
Model_11_stat <- describe(model_11)# fast = TRUE allow to compute only common stat summary, such as mean, SD, etc.

library(here)
png(filename = here("plot_folder", "Descriptive Statistic.png"), width = 2000, height = 2000, res = 300)
model_11_sum.stat <- sumtable(model_11,
         summ = c('notNA(x)',
                  'mean(x)',
                  'median(x)',
                  'sd(x)',
                  'min(x)',
                  'max(x)',
                  'skew(x)',
                  'kurtosi(x)'),
         title = "Descriptive Statistic of Variables/Items")
model_11_sum.stat

dev.off()
#psych::describe(model_11, fast = TRUE)
#
```

## 2 Principle Axis factoring 
### 2.1 Correlation Matrix for Dependent variabels  
```{r}
model_11_DV_corr <- round(cor(model_11_DVs), 2) # Correlation matrix

# Plot the correlation matrix for DVs
# To save plot in folder from corrplot, follow the steps: 1, 2, and then 3
library(corrplot)# to plot the correlation matrix 
#1
library(here)
png(filename = here("plot_folder", "DVs_Correlation matrix.png"), width = 2000, height = 2000, res = 300)
#2
corrplot(model_11_DV_corr, 
         method= "number",
         tl.col = "black",# label variable in black
         title = "Dependent Measured Items Correlation", 
         line = -1, # moves the title closer to the plot
         cex.main = 1.5) # adjusts the size of the title
model_11_DV_corr
# Save plot in the plot folder
library(here)# use to direct saving the plot in "plot_folder" and fucntion "here"

#3
dev.off()
```
### 2.1 Correlation Matrix for Independent variables  
```{r}
model_11_IV_corr <- round(cor(model_11_IVs), 2) # Correlation matrix
#write.csv(model_11_IV_corr, "IVs_correlation_matrix.csv")

# Plot the correlation matrix for DVs 
library(corrplot)# to plot the correlation matrix 
library(here)
png(filename = here("plot_folder", "IVs_Correlation matrix.png"), width = 2000, height = 2000, res = 300)

corrplot(model_11_IV_corr, 
         method = "number",
         tl.col = "black",# label variable in black
         number.cex = 0.6,
         title = "Independent Measured Items Correlation", 
         line = -2, # moves the title closer to the plot
         cex.main = 1.5) # adjusts the size of the title


#3
dev.off()
```

### 2.2 Diagnostic Test 
#### Normaliyt check for dependent variabels 
```{r}
# install.packages("MVN")
# library(MVN)
model_11_DVs_Norm <- mardia(model_11_DVs, plot = TRUE)
# 
# mvn(model_11_DVs, mvnTest = "mardia")
# IV <- mvn(model_11_IVs, mvnTest = "mardia")
```



#### A.Kaiser-Meyer-Olkin index (KMO)

* *KMO for DVs *
**Kaiser’s 1974 recommendations were:**
- bare minimum of .5
- values between .5 and .7 as mediocre
- values between .7 and .8 as good
- values above .9 are superb
```{r}
KMO(model_11_DVs)

# KMO = 0.90
# Variables at item level > 0.50, which is adequate for sample size 
# 
# Plot the value 
items_Dv <- c("IMPL_SUCC_1", "BUDG_COMP_2", "TASK_COMP_3", "STAKEH_ACC_4", "CULT_INTG_5", "DEPLOY_6", 
           "ACT_INTG_7", "EMPL_SKI_8", "EMPL_SAT_9", "EMPL_BEL_10", "BUSI_IMP_11", "ORG_IMP_12", "DEC_IMP_13")

values_DV <- c(0.96, 0.89, 0.89, 0.94, 0.89, 0.83, 0.86, 0.95, 0.86, 0.76, 0.95, 0.88, 0.94)

KMO_DVs <- data.frame(Items = items_Dv, Value = values_DV)

MSA_DVs <- ggplot(KMO_DVs, aes(x = reorder(Items, Value), y = Value)) + 
  geom_bar(stat = "identity", fill = "lightblue") + 
  coord_flip() + # function is used to swap the x and y axes so that the items are displayed horizontally
  labs(title = "MSA for Each Dependent Measured Item", 
       subtitle =  "Overall MSA =  0.9", 
       x = "Item", 
       y = "MSA Value") +
  #theme_minimal() +
  plotTheme()

# Save plot 
# library(here)# use to direct saving the plot in "plot_folder" and fucntion "here"
library(here)
#ggsave(filename = here("plot_folder", "KMO_DVs.png"), plot = MSA_DVs)
```
* *KMO for IVs* 
```{r}
KMO(model_11_IVs)

# KMO = 0.87
# Variables at item level > 0.50, which is adequate for sample size 
# 
# Plot the value 
items_Iv <- c("LD_SUP_1", "ORG_CUL_2", "EMP_ATT_3", "RES_AVL_4", "LD_INV_5", "PRJ_SEL_6", "DEF_MEA_7", "RES_CHG_8", "LD_STL_9", "ORG_CHR_10", "DAT_QLT_11", "EMP_ENG_12", "TOOL_AP_13", "CONTX_CUS_14", "EFT_REQ_15", "SCOPE_16", "INSTIT_17", "TRA_EDUC_18", "WKF_SKL_19", "EXP_CON_20", "EXT_CON_21", "UND_CNG_22", "COM_KNW_23", "PAT_RES_24", "GOAL_CL_25", "CUS_IDEF_26", "GOAL_AL_27", "SYS_COM_28", "TEAM_ST_29")

values_IV <- c(0.86, 0.91, 0.87, 0.75, 0.90, 0.87, 0.92, 0.91, 0.92, 0.90, 0.79, 0.89, 0.85, 0.84, 0.84, 
            0.88, 0.90, 0.86, 0.89, 0.87, 0.85, 0.77, 0.85, 0.80, 0.84, 0.89, 0.92, 0.85, 0.91)

KMO_IVs <- data.frame(Items = items_Iv, Value = values_IV)

MSA_IVs <- ggplot(KMO_IVs, aes(x = reorder(Items, Value), y = Value)) + 
  geom_bar(stat = "identity", fill = "lightblue") + 
  coord_flip() + # function is used to swap the x and y axes so that the items are displayed horizontally
  labs(title = "MSA for Each Independent Measured Item", 
       subtitle =  "Overall MSA =  0.87", 
       x = "Item", 
       y = "MSA Value") +
  #theme_minimal() +
  plotTheme()

# Save plot 
# library(here)# use to direct saving the plot in "plot_folder" and fucntion "here"
library(here)
#ggsave(filename = here("plot_folder", "KMO_IVs.png"), plot = MSA_IVs)

```

#### B.Bartlett’s test
* *Barlett’s for DVs* 
* A significant Barlett’s ($p < 0.05$) tells that the $R$-matrix is not an identity matrix. That is, there are some relationships between variables that can be analyzed
* The result of $p-value = 0.7.08*10^94$

```{r}
psych::cortest.bartlett(model_11_DVs)
```
* *Barlett’s for IVs* 
* The result of $p-value = 0.7.08*10^94$

```{r}
psych::cortest.bartlett(model_11_IVs)
```

#### C. Multicollinearity or singularity in my data
* *Multicollinearity for DVs*
* Determinant of the correlation matrix
- Det. of the correlation matrix should be greater than 0.00001
- The result of deteriminant is $1.802578e-05$
```{r}
det(cor(model_11_DVs))
```
* *Multicollinearity for IVs*
```{r}
det(cor(model_11_IVs))
```
- Note there might be multicollinearity with DVs (2.815678e-12) < 0.00001

### Principle Axis Factoring 

* Determine number of factor for DVs 
*Number of factor using with no rotation*
```{r}
model_11_DV_F <- psych::fa(model_11_DVs,nfactors = 7, fm = "pa", rotate = "none", max.iter = 100)
# no. of factor > 1.0 or 0.77 is 2 factor 
```
* Determine number of factor for IVs 
*Number of factor using with no rotation*
```{r}
model_11_IV_F <- psych::fa(model_11_IVs,nfactors = 10, fm = "pa", rotate = "none", max.iter = 100)
# no. of factor > 1.0 or 0.77 is 5 factor and the 6th factor is 0.76
```

*Number of factor using scree plot for DVs*
```{r}
#scree(model_11_DVs, main = "Scree plot for DVs")
# roughly 2 factor 

# Set up the PNG device
#png(filename = here("plot_folder", "Scree plot for DVs.png"))

# Plot
scree(model_11_DVs, main = "Scree plot for Dependent Measured Items")

# Turn off the device (this saves the plot)
#dev.off()

```

*Number of factor using scree plot for IVs*
```{r}
# Set up the PNG device
#png(filename = here("plot_folder", "Scree plot for IVs.png"))

scree(model_11_IVs, main = "Scree Plot for Independent Measured Items")
# roughly 3 factors or 4 

# Turn off the device (this saves the plot)
#dev.off()
```

*Number of factor using parallel analysis for DVs*

```{r}
# Set up the PNG device
#png(filename = here("plot_folder", "Parallel Analysis for DVs.png"))

fa.parallel(model_11_DVs, main = "Parallel Analysis for Dependent Measured Items")
# roughly 2 factor 

# Turn off the device (this saves the plot)
#dev.off()
```

*Number of factor using parallel analysis for IVs*

```{r}
# Set up the PNG device
#png(filename = here("plot_folder", "Parallel Analysis for IVs.png"))

fa.parallel(model_11_IVs, main = "Parallel Analysis for Independent Measured Items")
# suggested 4 to 5 factors  

# Turn off the device (this saves the plot)
#dev.off()
```



* Run Factor with determined factor number for *IVs*
```{r}
# with factor = 6
set.seed(3233)
model_11_IV_F6 <- psych::fa(model_11_IVs,nfactors = 6, fm = "pa", rotate = "oblimin", max.iter = 100)
psych::print.psych(model_11_IV_F6, cut = 0.3, sort=TRUE)

names(model_11_IV_F6)
mean(model_11_IV_F6$communality)
names(model_11_IVs)
################Experimenting removing some items from IVs with 6 factors ###########################################
# remove EXT_CON_21
set.seed(32433)
model_11_IV_F6_EXT_CON_21 <- psych::fa(model_11_IVs[, -which(names(model_11_IVs) == "EXT_CON_21")],nfactors = 6, fm = "pa", rotate = "oblimin", max.iter = 100)
psych::print.psych(model_11_IV_F6_EXT_CON_21, cut = 0.3, sort=TRUE)

# remove EMP_ENG_12, INSTIT_17, EXT_CON_21, COM_KNW_23, GOAL_CL_25, GOAL_AL_27, TEAM_ST_29
set.seed(32499)
model_11_IV_F6_Delt_7items <- psych::fa(model_11_IVs
                                        [, !names(model_11_IVs) %in% c("EMP_ENG_12", "INSTIT_17", "EXT_CON_21", "COM_KNW_23", "GOAL_CL_25", "GOAL_AL_27", "TEAM_ST_29")]
                                        ,nfactors = 6, fm = "pa", rotate = "oblimin", max.iter = 100)
psych::print.psych(model_11_IV_F6_Delt_7items, cut = 0.3, sort=TRUE)

# remove "ORG_CUL_2", "EMP_ATT_3", TOOL_AP_13
set.seed(32009)
model_11_IV_F6_Delt_10items <- psych::fa(model_11_IVs
                                        [, !names(model_11_IVs) %in% c("ORG_CUL_2", "EMP_ATT_3" ,"EMP_ENG_12", "TOOL_AP_13" ,"INSTIT_17", "EXT_CON_21", "COM_KNW_23", "GOAL_CL_25", "GOAL_AL_27", "TEAM_ST_29")]
                                        ,nfactors = 6, fm = "pa", rotate = "oblimin", max.iter = 100)
psych::print.psych(model_11_IV_F6_Delt_10items, cut = 0.3, sort=TRUE)
```

```{r}
# with factor = 5
set.seed(232333)
model_11_IV_F5 <- psych::fa(model_11_IVs,nfactors = 5, fm = "pa", rotate = "oblimin", max.iter = 100)
psych::print.psych(model_11_IV_F5, cut = 0.3, sort=TRUE)

# Mean communality
mean(model_11_IV_F5$communality)
```

```{r}
# with factor = 4
set.seed(2322)
model_11_IV_F4 <- psych::fa(model_11_IVs,nfactors = 4, fm = "pa", rotate = "oblimin", max.iter = 100)
psych::print.psych(model_11_IV_F4, cut = 0.3, sort=TRUE)

# mean communality 
mean(model_11_IV_F4$communality)
```

```{r}
# with factor = 3
set.seed(23225)
model_11_IV_F3 <- psych::fa(model_11_IVs,nfactors = 3, fm = "pa", rotate = "oblimin", max.iter = 100)
psych::print.psych(model_11_IV_F3, cut = 0.3, sort=TRUE)

# Mean communality 
mean(model_11_IV_F3$communality)
```

#### Principle Component analysis 
- Determine number of factors using eigenvalues 
```{r}
# NO. of factor for DVs
model_11_DVs_PCA <- psych::principal(model_11_DVs, nfactors = length(model_11_DVs), rotate = "none")
# 2 Components > 1
model_11_IVs_PCA <- psych::principal(model_11_IVs, nfactors = length(model_11_IVs), rotate = "none")
# 7 Components > 1

```

- PCA for DVs 
```{r}
# No. of factors 2 
set.seed(1114)
model_11_DVs_2PCA <- psych::principal(model_11_DVs, nfactors = 2, rotate = "oblimin")
psych::print.psych(model_11_DVs_2PCA, cut = 0.3, sort=TRUE)
```

- PCA for IVs
```{r}
# No. of factors 7 
set.seed(1115)
model_11_IVs_7PCA <- psych::principal(model_11_IVs, nfactors = 7, rotate = "oblimin")
psych::print.psych(model_11_IVs_7PCA, cut = 0.3, sort=TRUE)

# No. of factors 6
set.seed(11156)
model_11_IVs_6PCA <- psych::principal(model_11_IVs, nfactors = 6, rotate = "oblimin")
psych::print.psych(model_11_IVs_6PCA, cut = 0.3, sort=TRUE)

```

